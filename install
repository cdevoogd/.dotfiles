#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$BASE_DIR/.internal/scripts"

source "$SCRIPTS_DIR/helpers.sh"

# Use dotbot to clean dead links and symlink the dotfiles.
run_dotbot() {
    local dotbot_dir=".internal/dotbot"
    local dotbot_bin="$BASE_DIR/$dotbot_dir/bin/dotbot"
    local dotbot_config="$BASE_DIR/.internal/dotbot.yaml"

    git -C "$dotbot_dir" submodule sync --quiet --recursive
    "$dotbot_bin" --base-directory "$BASE_DIR" --config-file "$dotbot_config"
}

main() {
    if ! on_macos && ! on_linux; then
        echo "Unsupported operating system"
        return 1
    fi

    # This script is being sourced so that this script inherits the env updates (e.g. PATH)
    log "Installing packages"
    source "$SCRIPTS_DIR/install-packages.sh"

    log "Setting up the shell"
    "$SCRIPTS_DIR/configure-shell.sh"

    log "Setting up Git"
    "$BASE_DIR/git/setup.sh"

    cd "$BASE_DIR"
    log "Downloading all git submodules"
    git submodule update --init --recursive

    log "Running dotbot"
    run_dotbot
}

main "$@"
